{% extends "mySite/blog_base.html" %} {% load static %} {% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.1/js.cookie.js"></script>

<div class="align-items-center col-xs-12 fluid-responsive">
    <div class="card blog-main container col-md-8 col-xs-12">
        <h1>{% block title %} {{ object.title }} {% endblock title %}</h1>
        <i class="text-muted">{{ object.author }} | {{ object.date }} | {{object.time}} minute read | {{object.views}} views</i>
        <br>
        <br>
        <img class="img-fluid" src="{{object.image}}">
        <br>
        <br>

        <p class="card-text ">{{ object.content | safe }}</p>
        <br>
        <br>

        <div class="fluid-responsive align-items-center">
            <i class="text-muted mb-0 ml-2" id="like-counter"> {{likes}} people like this!</i> {% if liked == 1 %}

            <button class="btn-like unlike-review">
                <i class="fa fa-heart" aria-hidden="true"></i> You liked this
            </button> {% else %}
            <button class="btn-like like-review">
                <i class="fa fa-heart" aria-hidden="true"></i> Like
            </button> {% endif %}
        </div>

    </div>


    <div class="container col-md-8 align-items-center">
        <div class="container widget-area no-padding blank">
            <div class="status-upload">
                <h4>Comments</h4>
                <form class="comment-box">
                    <textarea id="comment-content" class="form-control" style="width: 100%;" placeholder="What are you doing right now?"></textarea>
                    <div class="share-button">
                        <button class="btn btn-success submit-comment green float-right mr-0"><i class="fa fa-share"></i> Share</button>
                    </div>
                </form>
            </div>
            <!-- Status Upload  -->
        </div>
        <!-- Widget Area -->
        <i>{{comments|length}} Comments</i>
        <hr>

        <!-- comments area -->

        {% for comment in comments %}
        <div class="container card-comments round2 card fluid-responsive">
            <div class="row">
                <h6 class="comment-user">{{comment.author}}</h6>
                <i class="text-muted comment-date">{{comment.date}}</i> {% if comment.author == user %}
                <a href="" onclick="deleteComment('{{comment.comment_id}}')" class="delete-button">Delete</a> {% endif%}
            </div>
            <p>
                -> {{comment.text}}
            </p>

        </div>

        {% endfor %}
    </div>



</div>


<script>
    var csrftoken = Cookies.get('csrftoken')

    function csrfSafeMethod(method) {
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    var liked = '{{liked}}'

    $(function() {
        $(document).on('click', '.unlike-review', function(e) {
            console.log("unnlike was called")

            if (liked == "-1") {
                alert("Please log in to like/dislike")
                return
            }
            // call ajax function here
            var payload = {
                blog_id: "{{object.blog_id}}",
            }
            $.ajax({
                type: 'POST',
                url: "{% url 'unlike_blogs' %}",
                data: {
                    'payload': payload,
                },
                // This is processing of what we get back
                success: function(msg) {
                    var response = msg['likes']
                    document.getElementById("like-counter").innerHTML = response + " people like this!"
                    $('.unlike-review').html('<i class="fa fa-heart" aria-hidden="true"></i> Like');
                    $('.unlike-review').addClass('like-review').removeClass('unlike-review');
                },
                error: function() {
                    console.log("Error")
                }

            });
        });
    });

    $(function() {
        $(document).on('click', '.like-review', function(e) {
            // call ajax function here

            if (liked == "-1") {
                alert("Please log in to like/dislike")
                return
            }
            var payload = {
                blog_id: "{{object.blog_id}}",
            }
            $.ajax({
                type: 'POST',
                url: "{% url 'like_blogs' %}",
                data: {
                    'payload': payload,
                },
                // This is processing of what we get back
                success: function(msg) {
                    var response = msg['likes']
                    document.getElementById("like-counter").innerHTML = response + " people like this!"
                    $('.like-review').html('<i class="fa fa-heart" aria-hidden="true"></i> You liked this');
                    $('.like-review').addClass('unlike-review').removeClass('like-review');
                },
                error: function() {
                    console.log("Error")
                }

            });
        });
    });



    $(function() {
        $(document).on('click', '.submit-comment', function(e) {
            // call ajax function here

            if (liked == "-1") {
                alert("Please log in to leave a comment")
                return
            }
            var payload = {
                blog_id: "{{object.blog_id}}",
                text: document.getElementById("comment-content").value
            }

            console.log(payload)
            $.ajax({
                type: 'POST',
                url: "{% url 'add_comment' %}",
                data: {
                    'payload': payload,
                },
                // This is processing of what we get back
                success: function(msg) {

                },
                error: function() {
                    console.log("Error")
                }

            });
        });
    });

    function deleteComment(comm_id) {
        console.log(comm_id)

        var payload = {
            comment_id: comm_id,
        }

        console.log(payload)
        $.ajax({
            type: 'POST',
            url: "{% url 'delete_comment' %}",
            data: {
                'payload': payload,
            },
            // This is processing of what we get back
            success: function(msg) {

            },
            error: function() {
                console.log("Error")
            }

        });
    }
</script>
{% endblock %}